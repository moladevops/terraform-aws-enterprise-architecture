# .github/workflows/terraform-ci.yml
name: ğŸ” Terraform CI - Tests & Validation

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  TF_VERSION: "1.5.0"
  AWS_REGION: "us-east-1"

jobs:
  security-and-quality:
    name: ğŸ›¡ï¸ Security & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸ” Terraform Format Check
      run: |
        echo "ğŸ¨ Checking Terraform formatting..."
        terraform fmt -check -recursive || {
          echo "âŒ Code is not properly formatted!"
          echo "Run 'terraform fmt -recursive' to fix formatting"
          exit 1
        }
        echo "âœ… Code formatting is correct!"
        
    - name: ğŸ” Terraform Validate
      run: |
        echo "ğŸ”§ Initializing Terraform..."
        terraform init -backend=false
        
        echo "âœ… Validating Terraform configuration..."
        terraform validate
        
        echo "âœ… All validation checks passed!"

  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: security-and-quality
    
    strategy:
      matrix:
        environment: [dev, staging, prod]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ”§ Terraform Init
      run: |
        terraform init \
          -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
          -backend-config="key=environments/${{ matrix.environment }}/terraform.tfstate" \
          -backend-config="region=${{ env.AWS_REGION }}" \
          -backend-config="dynamodb_table=${{ secrets.TF_STATE_LOCK_TABLE }}"
          
    - name: ğŸ“‹ Terraform Plan
      run: |
        echo "ğŸ“‹ Creating plan for ${{ matrix.environment }}..."
        terraform plan \
          -var-file="environments/${{ matrix.environment }}/${{ matrix.environment }}.tfvars" \
          -no-color

  notify-results:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [security-and-quality, terraform-plan]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify Success
      if: needs.security-and-quality.result == 'success' && needs.terraform-plan.result == 'success'
      run: |
        echo "ğŸ‰ All CI checks passed successfully!"
        echo "âœ… Security scan: PASSED"
        echo "âœ… Terraform validation: PASSED"
        echo "âœ… Multi-environment plans: PASSED"
        echo "ğŸš€ Ready for deployment!"
        
    - name: ğŸ“¢ Notify Failure
      if: needs.security-and-quality.result == 'failure' || needs.terraform-plan.result == 'failure'
      run: |
        echo "âŒ CI checks failed!"
        echo "ğŸ”§ Please fix the issues before merging"
        exit 1